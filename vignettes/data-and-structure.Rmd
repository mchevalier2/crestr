---
title: "The crestr package: data and structure"
author: "Manuel Chevalier"
output:
    rmarkdown::html_vignette:
        self_contained: no
vignette: >
  %\VignetteIndexEntry{The crestr package: data and structure}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```




```{r setup}
library(crestr)
```

> **_NOTE:_**  This vignette is still under development.





# Philosophy of the package

The `crestr` package has been designed for two independent but complementary modelling purposes. The probabilitic proxy-climate responses can be used to quantivatively reconstruct climate from their statistical combination, such as in @Chevalier2021Limpopo or @CC15, or, alternatively, they can be used in a more quantitative way to determine the (relative) climate sensitivities of different taxa in a given area to characterise past ecological changes, such as in @Chevalier2021Atlas or @Quick2021. The difficulty of running a CREST analysis lies in the definition of the study-specific parameters of the algorithm, which can make the learning curve a bit steep at the beginning. However, default values are provided for all parameters to enable an easy and rapid generation of preliminary results that users can then use as a reasonable first estimate to start adapting the model to their data. To guide users in this task and avoid the common 'black box' criticism faced by many complex statistical tools, a large array of publication-ready, graphical diagnostic tools was designed to automatically represent CREST data in a standardised way. These tools include plots of the calibration data, the estimated climate responses, the reconstructions and many more. They can be used to look at the data from different perspectives to help understanding why the results are what they are and possibly help identifying potential issues or biases in the selected data and/or parameters. Such diagnostic tools are available for every step of the process and, as examplified in section \ref{sec:howto}, they can be generated with a single line of R code.


<br >

```{r img1, echo=FALSE, fig.cap="**Fig. 1**: (left) Climate variable to reconstruct (*e.g.* mean annual temperature). (Right) Four distinct plant taxa living in that region and having a preference for the darker climates (*e.g.* a preference for colder climates). These four species produce undistinguisable pollen grains and, therefore, define a 'pollen type'. This example is based on pseudo-data.", out.width = '80%', fig.align = 'center', out.extra='style="background:none; border:none; box-shadow:none;"'}
knitr::include_graphics("https://raw.githubusercontent.com/mchevalier2/crestr/master/docs/articles/theory_files/figure-html/crest-01.png")
```


# The central element: the `crestObj` object

```{r crestobj, echo=FALSE, fig.cap = "Structure of a crestObj, here called 'rcnstrctn', with the five main sub-lists in colour. For simplicity, lists with many elements ('tax' or 'clim') are represented with double framed boxes. The unframed terminal nodes on the right-hand side of each branch are simple R objects, such as numbers, strings, vectors or data frames. The names of the functions that modify these obsjects are indicated on the right."}
knitr::include_graphics("/Users/mchevali1/Manuscripts/Chevalier-crestr/figs/fig-crestrobj_v1.png")
knitr::include_graphics("https://raw.githubusercontent.com/mchevalier2/crestr/master/docs/articles/theory_files/figure-html/crest-01.png")
```

In `crestr`, all the CREST-related data are stored within a single S3 object of the class `crestObj`. Most functions of the package will take a `crestObj` as their main input and will return an updated version of the object. In practice, a `crestObj` is a nested list that contains five sub-lists, each one grouping a specific type of information, such as the calibration data, the fitted climate responses and the reconstructions (see Fig. \ref{fig:crestobj}). Wrapper functions have been implemented to manipulate and/or modify the information contained in a `crestObj` so that, users are never expected to manually modify their `crestObj` --- even if it is possible. The five sub-lists contain the following information:

- `inputs`: contains the raw data (_e.g._ the counts/percentages, the ages of the samples or the names of the fossil taxa).

- `parameters`: contains the parameters provided at the different stages of the analysis (_e.g._ the data extraction or the fitting and combination of the PDFs)

- `modelling`: contains all the data related to the modelling part (_e.g._ the distribution data for calibration, the background climate space or the PDFs).

- `reconstructions`: contains all the results of the reconstruction (_e.g._ best estimates, synthetic error measurements as well as the full posterior distribution of the uncertainties).

- `misc`: contains some additional metadata relative to the reconstruction (_e.g._ the site location or, most importantly, information relative to the proxy-species equivalency described in section \ref{sec:inputs:pse}).





# Input data for `crestr` {#sec:package:inputs}

Four different input data files are compatible with `crestr`. However, only one up to three of these inputs may be required for any application depending on the modelling objectives and assumptions. These files can be prepared outside the R environment and imported using standard R functions.


\begin{table}[h]
    \caption{Example classification of four pollen taxa from the example case study, each one with a different level of taxonomic resolution. The last column 'Taxonomic resolution' is added here for illustrative purposes and should not included in the `PSE` table.}
    \begin{tabular}{c | c | ccc | c}
        \tophline
        Level & Family & Genus & Species & ProxyName & Taxonomic resolution \\
        \middlehline
        1 & Asteraceae & & & Asteracae undiff. & Family\\
        \middlehline
        2 & Asteraceae & \textit{Stoebe} & & \textit{Stoebe}-type & Subfamily \\
        2 & Asteraceae & \textit{Elytropappus} & & \textit{Stoebe}-type & Subfamily \\
        \middlehline
        2 & Asteraceae & \textit{Artemisia} & & \textit{Artemisia} & Genus level \\
        \middlehline
        3 & Arecaceae & \textit{Elaeis} & \textit{Elaeis guineensis} & \textit{Elaeis guineensis} & Species \\
        \middlehline
        4 &  &  &  & Triletes spores & To be excluded \\
        \bottomhline
    \end{tabular}
    \label{table:pse}
\end{table}


\begin{table}[h]
    \caption{Template for the \textit{distributions} data frame. The weights column, here indicated with a '*', is optional and can be omitted or its values all set to 1 to assign the same weight to each observation. The number of rows the of table should correspond to the number of unique occurrences available.}
    \begin{tabular}{cc|cc|c|ccc}
        \tophline
        Species name & Taxon Name & Longitude & Latitude & Weight* & clim\_1 & ... & clim\_n \\
        \middlehline
        \textit{Stoebe plumosa} & \textit{Stoebe}-type & 18.875 & -34.375 & 20 & 15.8 & ... & 711 \\
        \textit{Elytropappus rhinocerotis} & \textit{Stoebe}-type & 18.375 & -33.625 & 32 & 16.9 & ... & 477 \\
        ... & ... & ... & ... & ... & ... & ... & ... \\
        \textit{Elaeis guineensis} & \textit{Elaeis guineensis} & -4.375 & 10.875 & 4 & 27.4 & ... & 1020 \\
        \bottomhline
    \end{tabular}
    \label{table:distributions}
\end{table}




## The fossil data (`df`) {#sec:inputs:df}

The `df` data frame is only required if `crestr` is used for reconstucting climate and can be omitted if the objective is to model the climate response(s) of different taxa. `df` should be a data frame with the different samples entered as rows, with either the age, depth or sample ID as first column and the fossil data in the subsequent columns. `df` can countain raw counts, percentages, presence/absence (1s and 0s) or even relative weights to be used in the reconstruction. In the case study presented below for example (see section \ref{sec:howto:exampledata}), 215 terrestrial and aquatic pollen taxa were observed in 181 samples, so that `df` is a data frame with 216 columns (the age of the samples followed by the pollen taxa) and 181 rows containing pollen percentages of terrestrial taxa.




## The proxy-species equivalency (`PSE`) table {#sec:inputs:pse}

The `PSE` data frame is required to use the _gbif4crest_ calibration dataset. It is used to associate fossil taxon names to the species distributions of various species stored in the `TAXA` and `DISTRIB_QDGC` tables (Fig. \ref{fig:gbiftables}). When all the fossil taxa are identified at the species level, the `PSE` table should be a simple data frame with one row per taxon. In most cases, however, fossil taxa are identified at a higher taxonomic level (sub-genus, genus, sub-family, family) and these varying levels of identification should be encoded in the `PSE` file to link one or more (groups of) species to their common fossil taxon name.


A `PSE` file is composed of five columns (see Table \ref{table:pse}). The first one (_Level_) contains an integer that indicates the level of taxonomic resolution of the row (1 for Family, 2 for Genus, 3 for Species and 4 for taxa that should be excluded from the reconstruction, _e.g._ 'Triletes spores' in the example case study below). The fifth column 'ProxyName' contains the name of the taxon and columns two to four contain the taxonomic classification of that taxon as 'Family', 'Genus' and 'Species', respectively. For simplicity, a pre-formatted version of the `PSE` table with the names of all the taxa to study can be generated by `crestr` using the `createPSE(list_of_taxa)` function that generates a spreadsheet with the correct structure and with the Level and ProxyName columns automatically filled in.


When performing the classification with the `crest.get_modern_data()` function, `crestr` first classifies the taxa with the lowest taxonomical resolution (_i.e._ when _Level_ is equal to one), and then increases the resolution _Level_ by _Level_. In the example represented on Table \ref{table:pse}, different taxonomic resolution levels are provided for different plant species belonging to the highly diverse Asteraceae family (the daisy family). To distribute all the Asteraceae species observed across the study area to their appropriate category, all the species are first classified as 'Asteraceae undiff.'. In a second time, the classification of some of these Asteraceae species is refined when reaching the better resolved sub-groups (_Stoebe_-type and _Artemisia_ at _Level_ 2). At the end of the process, the 'Asteraceae undiff.' group only contains Asteraceae species that live in the study area but are not part of the genuses _Stoebe_, _Elytropappus_ or _Artemisia_. The latter are categorised separately as _Stoebe_-type or _Artemisia_. Additional names can also be included to the `PSE` file to exclude species that are known to not be part of a group. For instance, this could have been used to simplify the climate response of the 'Asteraceae undiff.' group by excluding more species from it. This categorisation process can be time-consuming, as all the taxa must be classified in the same `PSE` table, and will often require many iterations to be optimised. The results of the different assignments are stored in the `crestObj` returned by the `crest.get_modern_data()` function and can be evaluated by checking `rcnstrctn$misc$taxa_notes`.




## The alternative modern calibration dataset (`distributions`) {#sec:inputs:distributions}

Users that prefer fitting proxy-climate relationships from their own calibration data should prepare a `distributions` dataset following the specific structure presented in Table \ref{table:distributions}. The first two columns should contain the species names (or unique identifiers) and the corresponding proxy name. If more than one species correspond to one taxon, the PDFs will be fitted in two steps, as explained in section \ref{sec:method:crest}. The following two columns contain the coordinates of the species occurrence data. Finally, the last columns contain the climate values to be reconstructed. An optional column called `weight` can be added to `distributions` in fifth position (_i.e._ between the coordinates and the climate variables) if one wants to weight the different observations. For example, the (relative) abundance of taxa observed from modern data can be used when fitting the PDFs to give more importance to the observations where that abundance is highest.





## The `selectedTaxa` data frame {#sec:inputs:selectedTaxa}

The last data frame that can be used to inform the reconstruction is a data frame of ones and zeros called `selectedTaxa`. This data frame has as many rows and columns as there are taxa and climate variables, respectively. Each entry should be either 1 or 0 and is used to indicate if the taxon should be used to reconstruct the climate variable (value = 1) or not (value = 0). If it is not provided, a default `selectedTaxa` data frame with all entries set to 1 is added to the `crestObj`. Users can modify this information at any point using the `includeTaxa()` and `excludeTaxa()` built-in functions. The `crest.get_modern_data()` function also modifies this data frame by setting the value to -1 when the `PSE` classification failed for a taxon or when the amount of data in the study area is insufficient to fit a reliable PDF (see the parameters description in section \ref{sec:howto:get_modern_data}).







# CREST calibration dataset {#sec:method:calibration}

```{r gbif, out.width = "17.5cm", echo = FALSE, fig.cap = "Data density of the six climate proxies available in the gbif4crest calibration database. The total number of unique species occurrences (N) is indicated for each proxy. The maps are based on the ‘Equal Earth’ map projection to better account for the relative sizes of the different continents."}
knitr::include_graphics("/Users/mchevali1/Manuscripts/Chevalier-crestr/figs/fig-gbif_v1.png")
```

\begin{table}[h]
    \caption{List of terrestrial variables available in the gbif4crest database. Each one can be selected in crestr using its associated code. List of abbreviations: (Temp.) Temperature, (Precip.) Precipitation.}
    \begin{tabular}{| c | c | c |}
        \hline
        \multicolumn{3}{| c |}{Terrestrial variables} \\
        \hline
        Code & Full name & Source \\
        \hline
        bio1  & Mean Annual Temp. ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio2  & Mean Diurnal Range ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio3  & Isothermality (x100) & Fick and Hijmans (2017) \\
        bio4  & Temp. Seasonality  (standard deviation x100) ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio5  & Max Temp. of the Warmest Month ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio6  & Min Temp. of the Coldest Month ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio7  & Temp. Annual Range ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio8  & Mean Temp. of the Wettest Quarter ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio9  & Mean Temp. of the Driest Quarter ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio10 & Mean Temp. of the Warmest Quarter ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio11 & Mean Temp. of the Coldest Quarter ($\text{\textdegree}$C) & Fick and Hijmans (2017) \\
        bio12 & Annual precip. (mm) & Fick and Hijmans (2017) \\
        bio13 & Precip. of the Wettest Month (mm) & Fick and Hijmans (2017) \\
        bio14 & Precip. of the Driest Month (mm) & Fick and Hijmans (2017) \\
        bio15 & Precip. Seasonality (Coefficient of Variation) (mm) & Fick and Hijmans (2017) \\
        bio16 & Precip. of the Wettest Quarter (mm) & Fick and Hijmans (2017) \\
        bio17 & Precip. of the Driest Quarter (mm) & Fick and Hijmans (2017) \\
        bio18 & Precip. of the Warmest Quarter (mm) & Fick and Hijmans (2017) \\
        bio19 & Precip. of the Coldest Quarter (mm) & Fick and Hijmans (2017) \\
        ai    & Aridity Index (unitless) & Zomer et al. (2008) \\
        \hline
    \end{tabular}
    \label{table:variables-terr}
\end{table}


\begin{table}[h]
    \caption{List of marine variables available in the gbif4crest database. Each one can be selected in crestr using its associated code. List of abbreviations: (SST) Sea Surface Temperature, (SSS) Sea Surface Salinity.}
    \begin{tabular}{| c | c | c | c | c | c |}
        \hline
        \multicolumn{3}{| c |}{Oceanic variables}\\
        \hline
        Code & Full name & Source \\
        \hline
        sst\_ann & Mean Annual SST ($\text{\textdegree}$C) & Locarnini et al. (2018) \\
        sst\_jfm & Mean Winter SST ($\text{\textdegree}$C) & Locarnini et al. (2018) \\
        sst\_amj & Mean Spring SST ($\text{\textdegree}$C) & Locarnini et al. (2018) \\
        sst\_jas & Mean Summer SST ($\text{\textdegree}$C) & Locarnini et al. (2018) \\
        sst\_ond & Mean Fall SST ($\text{\textdegree}$C) & Locarnini et al. (2018) \\
        sss\_ann & Mean Annual SSS (PSU) & Zweng et al. (2018) \\
        sss\_jfm & Mean Winter SSS (PSU) & Zweng et al. (2018) \\
        sss\_amj & Mean Spring SSS (PSU) & Zweng et al. (2018) \\
        sss\_jas & Mean Summer SSS (PSU) & Zweng et al. (2018) \\
        sss\_ond & Mean Fall SSS (PSU) & Zweng et al. (2018) \\
        icec\_ann & Mean Annual Sea Ice Concentration (\%) & Reynolds et al. (2007) \\
        icec\_jfm & Mean Winter Sea Ice Concentration (\%) & Reynolds et al. (2007) \\
        icec\_amj & Mean Spring Sea Ice Concentration (\%) & Reynolds et al. (2007) \\
        icec\_jas & Mean Summer Ice Concentration (\%) & Reynolds et al. (2007) \\
        icec\_ond & Mean Fall Sea Ice Concentration (\%)  & Reynolds et al. (2007) \\
        diss\_oxy & Dissolved Oxygen Concentration (\textmu mol/L) & Garcia et al. (2018a) \\
        nitrate & Nitrate Concentration (\textmu mol/L) & Garcia et al. (2018b) \\
        phosphate & Phosphate Concentration (\textmu mol/L) & Garcia et al. (2018b) \\
        silicate & Silicate Concentration (\textmu mol/L) & Garcia et al. (2018b) \\
        \hline
    \end{tabular}
    \label{table:variables-mari}
\end{table}


```{r gbiftables, out.width = "17.5cm", echo = FALSE, fig.cap = "Structure of the gbif4crest PostgreSQL database. By default, the package extracts data from the TAXA, DISTRIB-QDGC and DATA-QDGC tables. The DISTRIB table contains the raw occurrence data and can be used to process the data at a different spatial resolution for example."}
knitr::include_graphics("/Users/mchevali1/Manuscripts/Chevalier-crestr/figs/fig-gbiftables_v1.png")
```

A multiproxy calibration dataset to estimate PDFs from a global collection of geolocalised presence-only data (hereafter proxy distributions) was first presented in @Chevalier2019. These data were obtained from the Global Biodiversity Information Facility (GBIF) database, an online collection of geolocalised observations of biological entities [@GBIFwebsite]. The calibration dataset [hereafter _gbif4crest_, @Chevalier2018GBIF] contains the species distributions of six common palaeoecological fossil: the five taxa presented in the original version of the dataset --- plants [@gbif_lycopodiopsida20, @gbif_antheceropsida20, @gbif_liliopsida20, @gbif_Cycadopsida20, @gbif_Magnoliopsida20, @gbif_pinopsida20, @gbif_gingkoopsida20, @gbif_polypodiopsida20, @gbif_gnetopsida20, @gbif_bryophyta21, @gbif_marchantiophyta21] for fossil pollen and macrofossils, chironomids [@GBIF_chironomids20], beetles [@GBIF_beetles20], diatoms [@GBIF_diatoms20] and foraminifera [@GBIF_forams20] -- to which rodents [@GBIF_rodents20] were recently added (Fig. \ref{fig:gbif}). All these data were curated in a relational database to ensure the consistency of the data.


The coordinates of all the presence records of these six common palaeoecological fossil proxies were upscaled at a spatial resolution of $0.25 \times 0.25^\circ$ (hereafter QDGC for Quarter-Degree Grid Cell) and subsequently associated with terrestrial and oceanic environmental variables at the same resolution [@Fick_Hijmans_2017, @Zomer2008, @WOA_2018_temp, @WOA_2018_salinity, @WOA_2018_oxy, @WOA_2018_nutrients, @Reynolds2007, see details in Tables \ref{table:variables-terr} and \ref{table:variables-mari}]. The QDGC spatial resolution is an empirical trade-off between numerous factors, including the resolution of the presence data, the quality of the data or the spatial representatitivity of the studied proxy (see discussions in @Chevalier_etal_2014 and @Chevalier2019). However, this tradeoff may be suboptimal in some situations and for that reason `crestr` can also be used with the raw GBIF data and even alternative calibration datasets.


In its current version (V2), the _gbif4crest_ calibration dataset contains about 25.3 millions unique presence data for the six proxies. Unfortunately, the density of data available varies strongly between proxies and regions (Fig. \ref{fig:gbif}). Plant data dominate the calibration dataset (>22 million unique occurrences) and allow for a use of `crestr` across all landmasses where vegetation currently grows. For the five other proxies, the datasets are still incomplete in many regions, which restricts the use of `crestr` (_e.g._ chironomids). However, these datasets are regularly updated by GBIF and while the first version of the _gbif4crest_ dataset released in 2018 contained about 17.5 million QDGC entries, the new version presented here contains about 25.3 million entries (~44% increase). The range of 'reconstructible' areas is thus rapidly broadening (see for instance the coverage of Russia by plant data compared to the first version of the _gbif4crest_ dataset presented in @Chevalier2019).


The _gbif4crest_ database is composed of three main types of data: taxonomic data (`TAXA` table on Fig. \ref{fig:gbiftables}), distribution data (`DISTRIB` and `DISTRIB_QDGC` tables) and diverse geopolitical, climatological and environmental data (`DATA_QDGC` table). Its structure is slightly different compared to the first version presented in @Chevalier2019 with a grouping of all the distinct QDGC tables in a unique `DATA_QDGC` table to enable a faster extraction of the data. Additional environmental and geographical discriptors were also added to characterise each grid cell and enable a more refined data selection. These include elevation and elevation variability @ETOPO, the country (https://www.naturalearthdata.com) or ocean (https://www.marineregions.org) names, as well as different levels of ecological classification for the terrestrial @olson2001 and marine @Costello2017 realms. The first and last date of observation are also now included, along with the type of observation, as reported by GBIF (see `DISTRIB_QDGC` table on Fig. \ref{fig:gbiftables}). Finally, the `DATA` table was entirely recalculated using a new protocol that better accounts for coastal margins so that climate values at some locations are expected to be slighty different from the first version of the _gbif4crest_ dataset.


Due to its large size (about 15 Gb), this database is not downloaded when installing the package, but it can be assessed in different ways. First, the data are stored in an open-access, cloud-based PostgreSQL database that can be dynamically accessed via `crestr`. This is the recommanded option, as users without any _a priori_ SQL knowledge can benefit from the package's interface to automatically query the database simply by providing study-specific parameters, such as the name of the taxa or boundaries for the study area, to import all the necessary data in the correct format to the R environment (see section \ref{sec:howto:get_modern_data}). Second, advanced users can also directly query the database to extract and curate data from the `DISTRIB` or `DISTRIB_QDGC` tables using the `dbRequest()` function, and subsequently associate these data with climate variables. Finally, the complete _gbif4crest_ calibration dataset can also be downloaded as a SQLite3 portable database file from @Chevalier2018GBIF.
